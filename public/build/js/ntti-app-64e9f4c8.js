const p=$("#sch_class_spec"),r=$("#sch_level"),i=$("#sch_shift"),l=$("#sch_skill"),y=$("#sch_info_student"),T=$("#btn_search"),v=$(".loader"),b=$("#pagination"),g=$("#pagination_list");$("#btn_print_card");$("#btn_print_card_view");$("#btn_update_view_info_print");var k=$("#txt_up_date_card");let f=1,h=1;function x(){const n=p.val(),t=r.val(),a=i.val(),s=l.val(),d={dept_code,class_code:n,sch_level:t,sch_shift:a,sch_skill:s};$.ajax({url:"/certificate/level_shift_skill",type:"POST",contentType:"application/json",data:JSON.stringify(d),headers:{"X-CSRF-TOKEN":csrfToken,"X-Requested-With":"XMLHttpRequest"},success:function(o){if(o.record_level&&o.record_level.length>0){const e=o.record_level[0].level,u=o.record_level[0].sections_code,w=o.record_level[0].skills_code;r.val(e),i.val(u),l.val(w),r.select2(),i.select2(),l.select2()}else r.val(""),i.val(""),l.val(""),r.select2(),i.select2(),l.select2()},error:function(o,e,u){notyf.error(`Error submitting class code: ${o.statusText||"Unknown error"}`)}})}function m(){const n="",t=r.val(),a=i.val(),s=l.val(),d={dept_code,class_code:n,sch_level:t,sch_shift:a,sch_skill:s};$.ajax({url:"/certificate/level_shift_skill",type:"POST",contentType:"application/json",data:JSON.stringify(d),headers:{"X-CSRF-TOKEN":csrfToken,"X-Requested-With":"XMLHttpRequest"},success:function(o){if(o.record_level&&o.record_level.length>0){const e=o.record_level[0].name;p.val(e),p.select2()}else notyf.error("រកមិនឃើញទិន្ន័យនៅក្នុងប្រព័ន្ធ")},error:function(o,e,u){notyf.error(`Error submitting class code: ${o.statusText||"Unknown error"}`)}})}function c(){v.css({position:"fixed",top:"50%",left:"50%",transform:"translate(-50%, -50%)","z-index":"1000"}).fadeIn("slow");const n=p.val(),t={dept_code,class_code:n,search:y.val(),page:f,rows_per_page:parseInt($("#pagination .rows_per_page").val()??50)};$.ajax({url:"/certificate/card_view",type:"POST",contentType:"application/json",data:JSON.stringify(t),headers:{"X-CSRF-TOKEN":csrfToken,"X-Requested-With":"XMLHttpRequest"},success:function(a){$("#tbl_stu_card_view").html(S(a)),$("#pagination").html(a.links),setTimeout(function(){v.fadeOut()},100)},error:function(a,s,d){notyf.error(`Error submitting class code: ${a.statusText||"Unknown error"}`)}})}function _(){v.css({position:"fixed",top:"50%",left:"50%",transform:"translate(-50%, -50%)","z-index":"1000"}).fadeIn("slow");const n=p.val(),t={dept_code,class_code:n,search:y.val(),page:h,rows_per_page:parseInt($("#pagination_list .rows_per_page").val()??50)};$.ajax({url:"/certificate/card_view_list",type:"POST",contentType:"application/json",data:JSON.stringify(t),headers:{"X-CSRF-TOKEN":csrfToken,"X-Requested-With":"XMLHttpRequest"},success:function(a){$("#tbl_card_stu_list").html(R(a)),$("#pagination_list").html(a.links),setTimeout(function(){v.fadeOut()},100)},error:function(a,s,d){notyf.error(`Error submitting class code: ${a.statusText||"Unknown error"}`)}})}function S(n){let t=n.current_page,a=n.page,s=n.data,d="";return s&&s.length>0?$.each(s,function(o,e){const u=`
                <div class="col-md-4 g-2 mt-2">
                    <div class="student-card-view" style="border: 2px solid ${e.status_print==1?"#2f99d1":"#ddd"};">
                        <img src="${e.photo_status==!1?"/asset/NTTI/images/faces/default_User.jpg":`/uploads/student/${e.stu_photo}`}" alt="Profile Picture" width="150" height="200" name="btn_update_view_info_print" id="btn_update_view_info_print" data-stu_code="${e.code}" data-dept_code="${e.department_code}" data-class_code="${e.class_code}" data-toggle="modal" data-target="#modal_card_update">
                        <div class="card-body student-information">
                            <div class="name">${e.name_2} ${e.name}</div>
                            <div class="id">${e.code}</div>
                            <div class="phone">${e.phone_student}</div>
                            <div class="info">${e.dept}</div>
                            <div class="info">${e.class==null?"No Class":e.class}</div>
                            <hr/>
                            <button type="button" class="btn btn-outline-info btn-sm" title="Print" name="btn_print_card_view" id="btn_print_card_view" data-stu_code="${e.code}" data-dept_code="${e.department_code}" data-class_code="${e.class_code}" data-toggle="modal" data-target="#modal_card_print_card">
                                <i class="mdi mdi-printer btn-icon-append"></i>
                            </button>
                            <button type="button" class="btn btn-outline-success btn-sm" title="View Detail">
                                <i class="mdi mdi-account-search"></i>
                            </button>
                            <button type="button" class="btn btn-outline-primary btn-sm" title="Update" name="btn_update_view_info_print" id="btn_update_view_info_print" data-stu_code="${e.code}" data-dept_code="${e.department_code}" data-class_code="${e.class_code}" data-toggle="modal" data-target="#modal_card_update">
                                <i class="mdi mdi-border-color"></i>
                            </button>
                            <button type="button" class="btn btn-outline-danger btn-sm" ${e.status_print==1?"":"hidden"} title="Disable Active Print" name="btn_diable_view_info_print" id="btn_diable_view_info_print" data-stu_code="${e.code}" data-dept_code="${e.department_code}" data-class_code="${e.class_code}" data-toggle="modal" data-target="#modal_card_disable_active">
                                <i class="mdi mdi-shuffle-disabled"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-rounded btn-icon pull-right" style="width: 30px;
    height: 30px;margin-right:5px">
                            <label class="text-primary">${o+1+(t-1)*a}</label>
                          </button>
                        </div>
                    </div>
                </div>
            `;d+=u}):(notyf.error("រកមិនឃើញទិន្ន័យនៅក្នុងប្រព័ន្ធ!"),d='<label class="text-center">រកមិនឃើញទិន្ន័យនៅក្នុងប្រព័ន្ធ!</label>'),d}function R(n){let t="",a=n.current_page,s=n.page,d=n.data;return d&&d.length>0?$.each(d,function(o,e){t+="<tr>",t+=`<td height="40">${o+1+(a-1)*s}</td>`,t+=`<td>${e.code}</td>`,t+=`<td>${e.name_2}</td>`,t+=`<td>${e.name}</td>`,t+=`<td>${e.gender}</td>`,t+=`<td>${e.date_of_birth??"No DOB"}</td>`,t+=`<td>${e.phone_student}</td>`,t+=`<td>${e.class==null?"No Class":e.class}</td>`,t+=`<td>${e.skill}</td>`,t+=`<td>${e.level}</td>`,t+="<td>",t+=`<div class="hover-photo">
                    <img src="${e.photo_status==!1?"/asset/NTTI/images/faces/default_User.jpg":`/uploads/student/${e.stu_photo}`}"  alt="John's Photo">
                </div>`,t+="</td>",t+=`<td>${e.status_print==1?'<div class="badge badge-success badge-pill">Already</div>':'<div class="badge badge-danger badge-pill">No</div>'}</td>`,t+=`<td><div class="dropdown">
            <button class="btn btn-primary dropdown-toggle d-flex align-items-center" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-list me-2"></i> <!-- Add your icon class here -->
                Menu
            </button>
            <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                <li><a class="dropdown-item" href="javascript:void(0)" name="btn_print_card_view" id="btn_print_card_view" data-stu_code="${e.code}" data-dept_code="${e.department_code}" data-class_code="${e.class_code}" data-toggle="modal" data-target="#modal_card_print_card"><i class="mdi mdi-printer btn-icon-append"></i> Print</a></li>
                <li><a class="dropdown-item" href="javascript:void(0)" title="View Detail"><i class="mdi mdi-account-search"></i> View</a></li>
                <li><a class="dropdown-item" href="javascript:void(0)" title="Update" name="btn_update_view_info_print" id="btn_update_view_info_print" data-stu_code="${e.code}" data-dept_code="${e.department_code}" data-class_code="${e.class_code}" data-toggle="modal" data-target="#modal_card_update"><i class="mdi mdi-border-color"></i> Update</a></li>
                <li ${e.status_print==1?"":"hidden"}><a class="dropdown-item" href="javascript:void(0)" title="Disable Active Print" name="btn_diable_view_info_print" id="btn_diable_view_info_print" data-stu_code="${e.code}" data-dept_code="${e.department_code}" data-class_code="${e.class_code}" data-toggle="modal" data-target="#modal_card_disable_active"><i class="mdi mdi-shuffle-disabled"></i> Disable</a></li>
            </ul>
            </div></td>`,t+="</tr>"}):(notyf.error("រកមិនឃើញទិន្ន័យនៅក្នុងប្រព័ន្ធ!"),t+="<tr>",t+='<td class="text-center" colspan="14" height="40"><label class="text-center">រកមិនឃើញទិន្ន័យនៅក្នុងប្រព័ន្ធ!</label></td>',t+="</tr>"),t}p.on("change",function(){x(),f=1,c(),h=1,_()});r.on("change",function(){m()});r.attr("disabled",!0);i.on("change",function(){m()});i.attr("disabled",!0);l.on("change",function(){m()});l.attr("disabled",!0);T.on("click",function(){f=1,c(),h=1,_()});b.on("click",".btn_refresh",function(){f=1,$("#pagination .rows_per_page").val(50),c()});b.on("change",".rows_per_page",function(n){n.preventDefault(),f=1,c()});b.on("click",".page-link[data-page]",function(n){n.preventDefault();var t=$(this).data("page");f=t,c()});g.on("click",".btn_refresh",function(){h=1,$("#pagination_list .rows_per_page").val(50),_()});g.on("change",".rows_per_page",function(n){n.preventDefault(),h=1,_()});g.on("click",".page-link[data-page]",function(n){n.preventDefault();var t=$(this).data("page");h=t,_()});$("body").on("click","#btn_print_card_view",function(n){const t=$(this).data("stu_code"),a=$(this).data("dept_code"),s=$(this).data("class_code");$("#hidden_stu_code").val(t),$("#hidden_dept_code").val(a),$("#hidden_class_code").val(s)});$("body").on("click","#btn_print_card",function(n){const t={stu_code:$("#hidden_stu_code").val(),dept_code:$("#hidden_dept_code").val(),class_code:$("#hidden_class_code").val()};$.ajax({url:"/certificate/print_card",type:"POST",contentType:"application/json",data:JSON.stringify(t),async:!1,headers:{"X-CSRF-TOKEN":csrfToken,"X-Requested-With":"XMLHttpRequest"},beforesend:function(){},success:function(a){jQuery(function(s){const d=s("<div>").html(a.view);s("body").append(d),d.printThis({importCSS:!1,importStyle:!1,removeInline:!1,printDelay:333,base:!1,formValues:!1}),d.remove()})},error:function(a,s,d){notyf.error(`Error submitting class code: ${a.statusText||"Unknown error"}`)}})});$("body").on("click","#btn_update_view_info_print",function(n){const t=$(this).data("stu_code"),a=$(this).data("dept_code"),s=$(this).data("class_code");$("#hidden_update_stu_code").val(t),$("#hidden_update_dept_code").val(a),$("#hidden_update_class_code").val(s);const d={stu_code:t,dept_code:a,class_code:s};$.ajax({url:"/certificate/card_view_info",type:"POST",contentType:"application/json",data:JSON.stringify(d),headers:{"X-CSRF-TOKEN":csrfToken,"X-Requested-With":"XMLHttpRequest"},success:function(o){$("#txt_up_view_name").html(o.name),$("#txt_up_view_id").html(o.code),$("#txt_up_view_class").html(o.class),$("#txt_up_view_skill").html(o.skill),$("#txt_up_view_level").html(o.level),$("#txt_up_view_shift").html(o.section_type),$("#txt_up_khmer_lunar").val(o.print_khmer_lunar??""),$("#txt_up_date_create").val("រាជធានីភ្នំពេញុ, "+o.print_khmer_date_format);var e=o.photo_status==!1?"/asset/NTTI/images/faces/default_User.jpg":`/uploads/student/${o.stu_photo}`;$("#txt_photo_student").attr("src",e)},error:function(o,e,u){notyf.error(`Error submitting class code: ${o.statusText||"Unknown error"}`)}})});$("body").on("click","#btn_update_info",function(n){let t=new FormData;t.append("stu_code",$("#hidden_update_stu_code").val()),t.append("dept_code",$("#hidden_update_dept_code").val()),t.append("class_code",$("#hidden_update_class_code").val());var a=$("#fileUploadProfileStu")[0].files[0];t.append("date",$("#txt_up_date_card").val()),t.append("khmer_lunar",$("#txt_up_khmer_lunar").val()),a?t.append("photo",a):t.append("photo",null),$.ajax({url:"/certificate/upload_student_info",type:"POST",processData:!1,contentType:!1,cache:!1,async:!1,data:t,headers:{"X-CSRF-TOKEN":csrfToken,"X-Requested-With":"XMLHttpRequest"},success:function(s){s.success==!0?(jQuery(function(d){d("#fm_card_update_info")[0].reset(),d("#txt_photo_student").attr("src","")}),c(),_(),notyf.success(s.message)):notyf.error(s.errors.photo[0])},error:function(s,d,o){notyf.error(`Error submitting class code: ${s.error||"Unknown error"}`)}})});$("#fileUploadProfileStu").on("change",function(){const n=this.files[0];if(n){const t=new FileReader;t.onload=function(a){$(".profile-image img").attr("src",a.target.result)},t.readAsDataURL(n)}});$("body").on("click","#btn_diable_view_info_print",function(n){const t=$(this).data("stu_code"),a=$(this).data("dept_code"),s=$(this).data("class_code");$("#hidden_disable_stu_code").val(t),$("#hidden_disable_dept_code").val(a),$("#hidden_diable_class_code").val(s)});$("body").on("click","#btn_card_disable_active",function(n){const t={stu_code:$("#hidden_disable_stu_code").val(),dept_code:$("#hidden_disable_dept_code").val(),class_code:$("#hidden_diable_class_code").val()};$.ajax({url:"/certificate/disable_student_info",type:"POST",contentType:"application/json",data:JSON.stringify(t),headers:{"X-CSRF-TOKEN":csrfToken,"X-Requested-With":"XMLHttpRequest"},success:function(a){a.success==!0?(c(),_(),notyf.success(a.message)):notyf.error(a.message)},error:function(a,s,d){notyf.error(`Error submitting class code: ${a.statusText||"Unknown error"}`)}})});k.on("change",function(){const n={date:$(this).val()};$.ajax({url:"/certificate/show_change_date_print_card",type:"POST",contentType:"application/json",data:JSON.stringify(n),headers:{"X-CSRF-TOKEN":csrfToken,"X-Requested-With":"XMLHttpRequest"},success:function(t){$("#txt_up_khmer_lunar").val(t.date_lunar),$("#txt_up_date_create").val(`រាជធានីភ្នំពេញុ, ${t.date_khmer}`)},error:function(t,a,s){notyf.error(`Error submitting class code: ${t.statusText||"Unknown error"}`)}})});$("body").on("click","#btn_upload_zip_photo",function(n){let t=new FormData;var a=$("#zipFile")[0].files[0];if(!a)return notyf.error("សូមជ្រើសរើស File Upload ប្រភេទ Zip"),!1;t.append("zipFile",a),t.append("dept_code",dept_code),$.ajax({url:"/certificate/upload_zip_photo",type:"POST",processData:!1,contentType:!1,cache:!1,async:!1,data:t,headers:{"X-CSRF-TOKEN":csrfToken,"X-Requested-With":"XMLHttpRequest"},success:function(s){s.status==200?($("#fm_up_card_base_option")[0].reset(),$(".modal-select2").modal("hide"),notyf.success(s.message),c()):notyf.error(s.message)},error:function(s,d,o){notyf.error(`Error submitting class code: ${s.error||"Unknown error"}`)}})});$("body").on("click","#btn_card_upload_multiple",function(n){let t=[];$("#previewContainer img").each(function(){let s=$(this).attr("src");if(s.startsWith("data:image")){let o=($(this).attr("alt")||"unnamed").split(".").slice(0,-1).join(".");t.push({name:o,src:s})}});const a={images:t};$.ajax({url:"/certificate/upload_multiple_photo",type:"POST",contentType:"application/json",data:JSON.stringify(a),headers:{"X-CSRF-TOKEN":csrfToken,"X-Requested-With":"XMLHttpRequest"},success:function(s){},error:function(s,d,o){notyf.error(`Error submitting class code: ${s.statusText||"Unknown error"}`)}})});$("body").on("change","#up_type_option",function(n){var t=$(this).val();t=="zip"?($("#up_zip").removeAttr("hidden"),$("#up_multiple").attr("hidden",!0)):t=="multiple"&&($("#up_multiple").removeAttr("hidden"),$("#up_zip").attr("hidden",!0))});c();_();
